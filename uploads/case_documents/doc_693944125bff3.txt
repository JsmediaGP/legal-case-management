<?php
session_start();
require_once '../engine/core/Auth.php';
Auth::requireLogin();
$user = Auth::user();
$pdo = db();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cases • ChamberSync</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="../assets/css/style.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .btn-navy { background:#0A2D5C; color:white; border:none; }
        .btn-navy:hover { background:#071F44; }
        .btn-gold { background:#C9A227; color:white; font-weight:600; }
        .btn-gold:hover { background:#b28e1e; }
        .modal-dialog { margin-left:280px; max-width:calc(100% - 280px); }
        .form-control[readonly], .form-control:disabled { background:#f8f9fa; }
        .badge { padding:6px 12px; font-size:0.9em; }
    </style>
</head>
<body class="bg-light">

    <?php include '../engine/inc/sidebar.php'; ?>

    <div class="topbar d-flex align-items-center justify-content-between">
        <h4 class="mb-0 text-navy fw-bold"><i class="fas fa-gavel me-2"></i> Case Management</h4>
        <button class="btn btn-gold px-5 py-3 shadow-sm fw-bold" data-bs-toggle="modal" data-bs-target="#caseModal">
            <i class="fas fa-plus-circle me-2"></i> NEW CASE
        </button>
    </div>

    <div class="main-content">
        <div class="card shadow border-0">
            <div class="card-body p-0">
                <table id="casesTable" class="table table-hover mb-0">
                    <thead class="bg-navy text-white">
                        <tr>
                            <th>Case No.</th>
                            <th>Parties</th>
                            <th>Category</th>
                            <th>Lawyer</th>
                            <th>Status</th>
                            <th>Next Hearing</th>
                            <th>Files</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php 
                        $cases = $pdo->query("SELECT c.*, u.first_name, u.last_name, 
                            (SELECT COUNT(*) FROM case_documents d WHERE d.case_id = c.case_id) as doc_count
                            FROM cases c 
                            LEFT JOIN users u ON c.assigned_lawyer_id = u.id 
                            ORDER BY c.created_at DESC")->fetchAll();
                        foreach ($cases as $c): ?>
                        <tr>
                            <td><strong class="text-navy"><?= $c['case_number'] ?></strong></td>
                            <td><?= substr($c['complainants'],0,30) ?>... vs <?= substr($c['respondents'],0,30) ?>...</td>
                            <td><span class="badge bg-primary"><?= ucfirst($c['category']) ?></span></td>
                            <td><?= $c['first_name'] ? $c['first_name'].' '.$c['last_name'] : '<em class="text-muted">Unassigned</em>' ?></td>
                            <td><span class="badge bg-warning text-dark"><?= ucwords(str_replace('-',' ',$c['current_status'])) ?></span></td>
                            <td><?= $c['next_hearing'] ? date('d M Y', strtotime($c['next_hearing'])) : '—' ?></td>
                            <td><span class="badge bg-success"><?= $c['doc_count'] ?></span></td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-btn" data-case='<?= json_encode($c) ?>'><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- NEW CASE MODAL -->
    <div class="modal fade" id="caseModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-navy text-white">
                    <h5 class="modal-title fw-bold">Create New Case</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="caseForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-5">
                                <label class="form-label fw-bold">Category</label>
                                <select id="category" name="category" class="form-select" required>
                                    <option value="civil">Civil</option>
                                    <option value="criminal">Criminal</option>
                                    <option value="family">Family</option>
                                    <option value="corporate">Corporate</option>
                                    <option value="land">Land Dispute</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Case Number (Auto)</label>
                                <input type="text" id="case_number" class="form-control bg-light" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">Billing Amount</label>
                                <input type="text" id="billing_amount" class="form-control bg-light" readonly>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Complainants / Petitioners</label>
                                <textarea name="complainants" class="form-control" rows="3" required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Respondents / Defendants</label>
                                <textarea name="respondents" class="form-control" rows="3" required></textarea>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Petition Date</label>
                                <input type="date" name="petition_date" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold text-warning">Next Hearing Date</label>
                                <input type="date" name="next_hearing" class="form-control">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-bold">Assign to Lawyer / Principal</label>
                                <select name="assigned_lawyer_id" class="form-select">
                                    <option value="">-- Select Lawyer --</option>
                                    <?php 
                                    $lawyers = $pdo->query("SELECT id, staff_id, first_name, last_name, designation FROM users 
                                                          WHERE designation IN ('lawyer','principal') AND status='active' 
                                                          ORDER BY first_name")->fetchAll();
                                    foreach ($lawyers as $l): ?>
                                        <option value="<?= $l['id'] ?>">
                                            <?= $l['staff_id'] ?> - <?= $l['first_name'] ?> <?= $l['last_name'] ?> 
                                            (<?= ucfirst($l['designation']) ?>)
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Upload Documents</label>
                                <input type="file" name="case_files[]" class="form-control" multiple 
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                                <small class="text-muted">PDF, Word, Images allowed</small>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-bold">Initial Instructions / Notes</label>
                                <textarea name="hearing_notes" class="form-control" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-gold px-5 fw-bold">CREATE CASE</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#casesTable').DataTable({ pageLength: 10, order: [[0, 'desc']] });

            const billingMap = { civil:150000, criminal:250000, family:120000, corporate:750000, land:350000 };

            $('#category').change(function() {
                const cat = $(this).val();
                $('#billing_amount').val('#' + billingMap[cat].toLocaleString());
                $.post('../engine/core/CaseHandler.php', { action: 'generate', category: cat }, function(num) {
                    $('#case_number').val(num);
                });
            }).trigger('change');

            $('#caseForm').submit(function(e) {
                e.preventDefault();
                let formData = new FormData(this);
                formData.append('action', 'create');

                $.ajax({
                    url: '../engine/core/CaseHandler.php',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res) {
                        Swal.fire('Success!', res.message, 'success').then(() => location.reload());
                    },
                    error: () => Swal.fire('Error!', 'Failed to create case', 'error')
                });
            });
        });
    </script>
</body>
</html>


<?php
// engine/core/CaseHandler.php
session_start();
require_once '../config/db.php';
require_once 'Auth.php';

if (!Auth::isLoggedIn()) {
    echo json_encode(['success' => false, 'message' => 'Unauthorized']);
    exit();
}

$pdo = db();
$userId = $_SESSION['user_id'];
$uploadDir = '../../uploads/case_documents/';
if (!is_dir($uploadDir)) mkdir($uploadDir, 0777, true);

function generateCaseNumber($category) {
    $prefix = strtoupper(substr($category, 0, 3));
    $year = date('Y');
    $pdo = db();
    $stmt = $pdo->query("SELECT case_number FROM cases WHERE case_number LIKE '$prefix/%/$year' ORDER BY case_id DESC LIMIT 1");
    $last = $stmt->fetchColumn();
    $next = $last ? str_pad((int)explode('/', $last)[1] + 1, 3, '0', STR_PAD_LEFT) : '001';
    return "$prefix/$next/$year";
}

$billingMap = ['civil' => 150000, 'criminal' => 250000, 'family' => 120000, 'corporate' => 750000, 'land' => 350000];

// GENERATE CASE NUMBER
if (isset($_POST['action']) && $_POST['action'] === 'generate') {
    echo generateCaseNumber($_POST['category']);
    exit();
}

// CREATE CASE
if ($_POST['action'] === 'create') {
    $case_number = generateCaseNumber($_POST['category']);
    $billing = $billingMap[$_POST['category']] ?? 0;

    $stmt = $pdo->prepare("INSERT INTO cases 
        (case_number, complainants, respondents, description, category, subcategory,
         petition_date, next_hearing, suit_number, assigned_by, assigned_lawyer_id,
         billing_amount, payment_status, current_status, hearing_notes)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)");

    $success = $stmt->execute([
        $case_number,
        $_POST['complainants'],
        $_POST['respondents'],
        $_POST['description'] ?? '',
        $_POST['category'],
        $_POST['subcategory'] ?? '',
        $_POST['petition_date'] ?: null,
        $_POST['next_hearing'] ?: null,
        null,
        $userId,
        $_POST['assigned_lawyer_id'] ?: null,
        $billing,
        'pending',
        'pre-litigation',
        $_POST['hearing_notes'] ?? ''
    ]);

    if ($success) {
        $case_id = $pdo->lastInsertId();
        if (!empty($_FILES['case_files']['name'][0])) {
            foreach ($_FILES['case_files']['name'] as $key => $name) {
                if ($_FILES['case_files']['error'][$key] === 0) {
                    $ext = pathinfo($name, PATHINFO_EXTENSION);
                    $fileName = uniqid('doc_') . '.' . $ext;
                    $filePath = $uploadDir . $fileName;
                    if (move_uploaded_file($_FILES['case_files']['tmp_name'][$key], $filePath)) {
                        $stmt2 = $pdo->prepare("INSERT INTO case_documents 
                            (case_id, file_name, file_path, file_type, uploaded_by_user_id, upload_date)
                            VALUES (?, ?, ?, ?, ?, NOW())");
                        $stmt2->execute([$case_id, $name, 'uploads/case_documents/'.$fileName, $ext, $userId]);
                    }
                }
            }
        }
        echo json_encode(['success' => true, 'message' => "Case $case_number created!"]);
    } else {
        echo json_encode(['success' => false, 'message' => 'Failed to create case']);
    }
    exit();
}

// UPDATE CASE — NOW WORKS 100%
if ($_POST['action'] === 'update') {
    $stmt = $pdo->prepare("UPDATE cases SET 
        complainants=?, respondents=?, description=?, category=?, subcategory=?,
        petition_date=?, next_hearing=?, suit_number=?, assigned_lawyer_id=?,
        current_status=?, payment_status=?, hearing_notes=?
        WHERE case_id=?");

    $success = $stmt->execute([
        $_POST['complainants'],
        $_POST['respondents'],
        $_POST['description'] ?? '',
        $_POST['category'],
        $_POST['subcategory'] ?? '',
        $_POST['petition_date'] ?: null,
        $_POST['next_hearing'] ?: null,
        $_POST['suit_number'],
        $_POST['assigned_lawyer_id'] ?: null,
        $_POST['current_status'],
        $_POST['payment_status'],
        $_POST['hearing_notes'] ?? '',
        $_POST['case_id']
    ]);

    // Upload more files
    if ($success && !empty($_FILES['case_files']['name'][0])) {
        foreach ($_FILES['case_files']['name'] as $key => $name) {
            if ($_FILES['case_files']['error'][$key] === 0) {
                $ext = pathinfo($name, PATHINFO_EXTENSION);
                $fileName = uniqid('doc_') . '.' . $ext;
                $filePath = $uploadDir . $fileName;
                if (move_uploaded_file($_FILES['case_files']['tmp_name'][$key], $filePath)) {
                    $stmt2 = $pdo->prepare("INSERT INTO case_documents 
                        (case_id, file_name, file_path, file_type, uploaded_by_user_id, upload_date)
                        VALUES (?, ?, ?, ?, ?, NOW())");
                    $stmt2->execute([$_POST['case_id'], $name, 'uploads/case_documents/'.$fileName, $ext, $userId]);
                }
            }
        }
    }

    echo json_encode(['success' => $success, 'message' => $success ? 'Case updated successfully!' : 'Update failed']);
    exit();
}

// DELETE CASE (HOC only)
if ($_POST['action'] === 'delete' && Auth::isHeadOfChamber()) {
    $stmt = $pdo->prepare("DELETE FROM cases WHERE case_id = ?");
    $success = $stmt->execute([$_POST['case_id']]);
    echo json_encode(['success' => $success, 'message' => $success ? 'Case deleted!' : 'Error']);
    exit();
}



